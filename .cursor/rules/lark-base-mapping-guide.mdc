---
description: 
globs: 
alwaysApply: false
---
# Lark Base Mapping é¡¹ç›®å¼€å‘æŒ‡å—

## é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäº PocketBase çš„é£ä¹¦å¤šç»´è¡¨æ ¼æ˜ å°„æœåŠ¡ï¼Œä½¿ç”¨ Go è¯­è¨€å¼€å‘ï¼Œæä¾›é£ä¹¦ï¼ˆLarkï¼‰å’Œ GitLab çš„é›†æˆåŠŸèƒ½ã€‚

### æŠ€æœ¯æ ˆ
- **åç«¯æ¡†æ¶**: PocketBase (åŸºäº Go çš„ BaaS è§£å†³æ–¹æ¡ˆ)
- **è¯­è¨€**: Go 1.23+
- **ä¸»è¦ä¾èµ–**: 
  - `github.com/pocketbase/pocketbase` - åç«¯æ¡†æ¶
  - `github.com/larksuite/oapi-sdk-go/v3` - é£ä¹¦ Open API SDK
  - `github.com/joho/godotenv` - ç¯å¢ƒå˜é‡ç®¡ç†

## é¡¹ç›®æ¶æ„

### ç›®å½•ç»“æ„
```
â”œâ”€â”€ main.go                          # åº”ç”¨ç¨‹åºå…¥å£ç‚¹ï¼Œé…ç½®è·¯ç”±å’Œä¸­é—´ä»¶
â”œâ”€â”€ config.go                        # é…ç½®ç®¡ç†ï¼ˆé£ä¹¦å’ŒGitLabé…ç½®ï¼‰
â”œâ”€â”€ types/                           # æ•°æ®ç»“æ„å®šä¹‰
â”‚   â””â”€â”€ gitlab.go                    # GitLab webhook æ•°æ®ç»“æ„
â”œâ”€â”€ handlers/                        # ä¸šåŠ¡å¤„ç†é€»è¾‘
â”‚   â”œâ”€â”€ gitlab_system_hook.go        # GitLabç³»ç»Ÿé’©å­äº‹ä»¶å¤„ç†
â”‚   â”œâ”€â”€ gitlab_merge_request.go      # GitLabåˆå¹¶è¯·æ±‚äº‹ä»¶å¤„ç†
â”‚   â””â”€â”€ gitlab_note.go               # GitLabè¯„è®ºäº‹ä»¶å¤„ç†
â”œâ”€â”€ middlewares/                     # ä¸­é—´ä»¶ç›®å½•
â”‚   â”œâ”€â”€ lark.go                      # é£ä¹¦è®¤è¯ä¸­é—´ä»¶
â”‚   â””â”€â”€ gitlab.go                    # GitLab webhookä¸­é—´ä»¶
â”œâ”€â”€ router/                          # è·¯ç”±å¤„ç†å™¨ç›®å½•
â”‚   â”œâ”€â”€ lark.go                      # é£ä¹¦ç›¸å…³APIè·¯ç”±
â”‚   â””â”€â”€ gitlab_webhook.go            # GitLab webhookè·¯ç”±åˆ†å‘
â”œâ”€â”€ migrations/                      # æ•°æ®åº“è¿ç§»æ–‡ä»¶
â”œâ”€â”€ pb_data/                         # PocketBase æ•°æ®ç›®å½•
â””â”€â”€ README.md                        # é¡¹ç›®æ–‡æ¡£
```

### åˆ†å±‚æ¶æ„è®¾è®¡

#### Types å±‚ - æ•°æ®ç»“æ„å®šä¹‰
- **èŒè´£**: çº¯æ•°æ®ç»“æ„å®šä¹‰ï¼Œæ— ä¸šåŠ¡é€»è¾‘
- **ç‰¹ç‚¹**: æä¾›ç±»å‹å®‰å…¨ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•
- **æ–‡ä»¶**: `types/gitlab.go` - åŒ…å«æ‰€æœ‰ GitLab webhook ç›¸å…³çš„æ•°æ®ç»“æ„

#### Handlers å±‚ - ä¸šåŠ¡å¤„ç†é€»è¾‘  
- **èŒè´£**: æ ¸å¿ƒä¸šåŠ¡å¤„ç†é€»è¾‘ï¼Œå¯ç‹¬ç«‹æµ‹è¯•
- **ç‰¹ç‚¹**: ä¸“æ³¨äºç‰¹å®šä¸šåŠ¡é¢†åŸŸï¼Œæ˜“äºå•å…ƒæµ‹è¯•
- **æ–‡ä»¶**:
  - `handlers/gitlab_system_hook.go` - ç³»ç»Ÿé’©å­äº‹ä»¶å¤„ç†
  - `handlers/gitlab_merge_request.go` - åˆå¹¶è¯·æ±‚äº‹ä»¶å¤„ç†
  - `handlers/gitlab_note.go` - è¯„è®ºäº‹ä»¶å¤„ç†

#### Router å±‚ - è·¯ç”±åˆ†å‘
- **èŒè´£**: ä»…è´Ÿè´£è·¯ç”±åˆ†å‘ï¼Œè½»é‡åŒ–
- **ç‰¹ç‚¹**: ç®€æ´çš„è·¯ç”±é€»è¾‘ï¼Œå¿«é€Ÿåˆ†å‘åˆ°å¯¹åº”å¤„ç†å™¨
- **æ–‡ä»¶**: `router/gitlab_webhook.go` - GitLab webhook è·¯ç”±åˆ†å‘

### æ ¸å¿ƒæ¶æ„

#### PocketBase é›†æˆæ¨¡å¼
- **åº”ç”¨åˆå§‹åŒ–**: åœ¨ `main.go` ä¸­ä½¿ç”¨ `pocketbase.New()` åˆ›å»ºåº”ç”¨å®ä¾‹
- **ä¸­é—´ä»¶ç»‘å®š**: ä½¿ç”¨ `.BindFunc()` æ–¹æ³•ç»‘å®šä¸­é—´ä»¶åˆ°è·¯ç”±
- **äº‹ä»¶ç›‘å¬**: ä½¿ç”¨ `app.OnServe()` ç›‘å¬æœåŠ¡äº‹ä»¶å¹¶æ³¨å†Œè·¯ç”±

#### ä¸­é—´ä»¶è®¾è®¡
ä¸­é—´ä»¶é‡‡ç”¨é—­åŒ…æ¨¡å¼è®¾è®¡ï¼š
```go
// é£ä¹¦ä¸­é—´ä»¶å·¥å‚å‡½æ•°
func LarkAuth(config *LarkConfig) func(e *core.RequestEvent) error

// GitLab webhookéªŒè¯ä¸­é—´ä»¶
func GitLabWebhook(config *GitLabConfig) func(e *core.RequestEvent) error
```

## GitLab æ¨¡å—é‡æ„è¯´æ˜

åŸæ¥çš„å¤§å‹ `router/gitlab.go` æ–‡ä»¶å·²ç»æŒ‰ç…§èŒè´£å’ŒåŠŸèƒ½è¿›è¡Œäº†æ¨¡å—åŒ–é‡æ„ï¼Œç°åœ¨é‡‡ç”¨æ›´æ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼š

### é‡æ„åçš„æ¨¡å—ç»“æ„

#### ğŸ“ `types/` - æ•°æ®ç»“æ„å®šä¹‰
- **`gitlab.go`** (17KB, 460è¡Œ) - åŒ…å«æ‰€æœ‰ GitLab webhook ç›¸å…³çš„æ•°æ®ç»“æ„å®šä¹‰
  - `FlexibleTime` - è‡ªå®šä¹‰æ—¶é—´ç±»å‹ï¼Œæ”¯æŒå¤šç§æ—¶é—´æ ¼å¼è§£æ
  - åŸºç¡€ç»“æ„ä½“ï¼š`User`, `Project`, `Repository`, `Commit`, `Author`, `Label` ç­‰
  - å„ç§äº‹ä»¶ç»“æ„ä½“ï¼ˆMerge Requestã€System Hookã€Noteç­‰ï¼‰
  - ç³»ç»Ÿäº‹ä»¶ç»“æ„ä½“ï¼ˆé¡¹ç›®ã€ç”¨æˆ·ã€ç»„ã€è®¿é—®è¯·æ±‚ã€å¯†é’¥ç­‰ï¼‰

#### ğŸ“ `handlers/` - ä¸šåŠ¡å¤„ç†é€»è¾‘
- **`gitlab_system_hook.go`** (17KB, 509è¡Œ) - ç³»ç»Ÿé’©å­äº‹ä»¶å¤„ç†
  - `HandleSystemHookEvent()` - ç³»ç»Ÿé’©å­äº‹ä»¶æ€»å…¥å£
  - æ”¯æŒæ–°æ ¼å¼å’Œä¼ ç»Ÿæ ¼å¼ç³»ç»Ÿäº‹ä»¶
  - é¡¹ç›®ã€ç”¨æˆ·ã€ç»„ã€è®¿é—®è¯·æ±‚ã€å¯†é’¥ã€ä»“åº“æ›´æ–°ç­‰äº‹ä»¶å¤„ç†
  
- **`gitlab_merge_request.go`** (8.8KB, 222è¡Œ) - Merge Request äº‹ä»¶å¤„ç†
  - `HandleMergeRequestEvent()` - æ ‡å‡† MR Hook äº‹ä»¶å¤„ç†
  - `HandleSystemHookMergeRequestEvent()` - System Hook æ ¼å¼çš„ MR äº‹ä»¶å¤„ç†
  - æ•°æ®åº“è®°å½•ä¿å­˜å’Œä½œè€…ä¿¡æ¯å®‰å…¨å¤„ç†
  
- **`gitlab_note.go`** (4.5KB, 148è¡Œ) - Note/è¯„è®ºäº‹ä»¶å¤„ç†
  - `HandleNoteEvent()` - Note Hook äº‹ä»¶å¤„ç†
  - æ”¯æŒå¤šç§è¯„è®ºç±»å‹ï¼šMergeRequest, Issue, Commit, Snippet

#### ğŸ“ `router/` - è·¯ç”±åˆ†å‘ï¼ˆä»…ä¿ç•™è·¯ç”±é€»è¾‘ï¼‰
- **`gitlab_webhook.go`** (2.6KB, 93è¡Œ) - ä¸»è¦çš„ webhook è·¯ç”±åˆ†å‘
  - `GitLabWebhook()` - ä¸»è¦çš„ webhook å…¥å£å‡½æ•°
  - æ ¹æ® `X-Gitlab-Event` å¤´éƒ¨åˆ†å‘åˆ°å¯¹åº”çš„å¤„ç†å™¨
  - åŸºç¡€äº‹ä»¶å¤„ç†å™¨çš„å ä½ç¬¦å®ç°ï¼ˆPush, Tag Push, Issuesï¼‰

### é‡æ„è®¾è®¡åŸåˆ™

#### 1. **å•ä¸€èŒè´£åŸåˆ™**
æ¯ä¸ªç›®å½•å’Œæ–‡ä»¶éƒ½æœ‰æ˜ç¡®çš„èŒè´£ï¼š
- `types/` ä¸“æ³¨äºæ•°æ®ç»“æ„å®šä¹‰
- `handlers/` ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘å¤„ç†
- `router/` ä¸“æ³¨äºè¯·æ±‚è·¯ç”±åˆ†å‘

#### 2. **æ¨¡å—åŒ–å’Œå¯æ‰©å±•æ€§**
- æ–°å¢äº‹ä»¶ç±»å‹åªéœ€åœ¨å¯¹åº”æ¨¡å—ä¸­æ·»åŠ 
- æ•°æ®ç»“æ„å˜æ›´é›†ä¸­åœ¨ `types/` ç›®å½•
- ä¸šåŠ¡é€»è¾‘åˆ†æ•£åˆ°å¯¹åº”çš„å¤„ç†å™¨
- æ˜“äºè¿›è¡Œå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

#### 3. **èŒè´£æ¸…æ™°**
- æ¯ä¸ªæ¨¡å—éƒ½æœ‰æ˜ç¡®çš„è¾“å…¥è¾“å‡ºæ¥å£
- æ¨¡å—é—´ä¾èµ–å…³ç³»æ¸…æ™°
- ä¾¿äºå›¢é˜Ÿå¹¶è¡Œå¼€å‘

### é‡æ„ä½¿ç”¨æŒ‡å—

#### 1. æ·»åŠ æ–°çš„äº‹ä»¶ç±»å‹
1. åœ¨ `types/gitlab.go` ä¸­æ·»åŠ æ•°æ®ç»“æ„
2. åœ¨ `handlers/` ä¸­åˆ›å»ºæˆ–æ‰©å±•å¤„ç†å™¨
3. åœ¨ `router/gitlab_webhook.go` ä¸­æ·»åŠ è·¯ç”±åˆ†å‘

#### 2. ä¿®æ”¹ç°æœ‰äº‹ä»¶å¤„ç†
ç›´æ¥åœ¨ `handlers/` ç›®å½•ä¸­å¯¹åº”çš„å¤„ç†å™¨æ–‡ä»¶ä¸­ä¿®æ”¹

#### 3. æ·»åŠ æ–°çš„æ•°æ®ç»“æ„
åœ¨ `types/gitlab.go` ä¸­æ·»åŠ ï¼Œæ‰€æœ‰æ¨¡å—éƒ½å¯ä»¥é€šè¿‡å¯¼å…¥ä½¿ç”¨

#### 4. å¯¼å…¥è·¯å¾„ç¤ºä¾‹

```go
// ä½¿ç”¨æ•°æ®ç±»å‹
import "gitlab.yogorobot.com/sre/lark-base-mapping/types"

// ä½¿ç”¨å¤„ç†å™¨
import "gitlab.yogorobot.com/sre/lark-base-mapping/handlers"

// ä½¿ç”¨è·¯ç”±
import "gitlab.yogorobot.com/sre/lark-base-mapping/router"
```

### é‡æ„ä¸»è¦æ”¹è¿›

1. **å¯è¯»æ€§æå‡**: æ¯ä¸ªæ–‡ä»¶ä¸“æ³¨äºç‰¹å®šåŠŸèƒ½ï¼Œä»£ç æ›´æ˜“è¯»æ˜“æ‡‚
2. **ç»´æŠ¤æ€§æå‡**: ä¿®æ”¹ç‰¹å®šåŠŸèƒ½æ—¶ä¸ä¼šå½±å“å…¶ä»–æ¨¡å—
3. **æ‰©å±•æ€§æå‡**: æ–°å¢åŠŸèƒ½æ—¶æœ‰æ˜ç¡®çš„æ·»åŠ ä½ç½®å’Œè§„èŒƒ
4. **å›¢é˜Ÿåä½œ**: å¤šäººå¼€å‘æ—¶å¯ä»¥å¹¶è¡Œä¿®æ”¹ä¸åŒæ¨¡å—
5. **æµ‹è¯•å‹å¥½**: å¯ä»¥é’ˆå¯¹æ¯ä¸ªæ¨¡å—è¿›è¡Œå•ç‹¬çš„å•å…ƒæµ‹è¯•
6. **èŒè´£æ¸…æ™°**: æ¯ä¸ªç›®å½•éƒ½æœ‰æ˜ç¡®çš„èŒè´£è¾¹ç•Œ

## API ç«¯ç‚¹

### é£ä¹¦å¤šç»´è¡¨æ ¼ API
- `GET /base/{baseID}/{tableID}/{recordID}` - è·å–ç‰¹å®šè®°å½•
- `GET /base/{baseID}/{tableID}` - è·å–è¡¨æ ¼æ•°æ®

### GitLab Webhook API
- `POST /webhook/gitlab` - GitLab webhook æ¥æ”¶ç«¯ç‚¹

## å¼€å‘è§„èŒƒ

### ç¯å¢ƒå˜é‡é…ç½®
åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®ï¼š
```bash
# é£ä¹¦é…ç½®
LARK_APP_ID=cli_xxx
LARK_APP_SECRET=xxx
LARK_BASE_URL=https://open.feishu.cn
LARK_WEB_URL=

# GitLabé…ç½®
GITLAB_WEBHOOK_SECRET=xxx
GITLAB_BASE_URL=https://gitlab.com
```

### é…ç½®ç®¡ç†æ¨¡å¼
æ‰€æœ‰é…ç½®é€šè¿‡ `config.go` ç»Ÿä¸€ç®¡ç†ï¼š
```go
func LoadConfig() *LarkApp        // åŠ è½½é£ä¹¦é…ç½®
func LoadGitLabConfig() *GitLabConfig  // åŠ è½½GitLabé…ç½®
```

### é”™è¯¯å¤„ç†è§„èŒƒ
ä½¿ç”¨ PocketBase æä¾›çš„é”™è¯¯å¤„ç†æ–¹æ³•ï¼š
```go
e.BadRequestError("é”™è¯¯ä¿¡æ¯", err)      // 400é”™è¯¯
e.UnauthorizedError("è®¤è¯å¤±è´¥", nil)    // 401é”™è¯¯
e.NotFoundError("èµ„æºæœªæ‰¾åˆ°", nil)      // 404é”™è¯¯
e.InternalServerError("æœåŠ¡å™¨é”™è¯¯", err) // 500é”™è¯¯
```

### æ—¥å¿—è®°å½•è§„èŒƒ
```go
e.App.Logger().Info("ä¿¡æ¯æ—¥å¿—", "key", value)
e.App.Logger().Warn("è­¦å‘Šæ—¥å¿—", "error", err)
e.App.Logger().Error("é”™è¯¯æ—¥å¿—", "error", err)
e.App.Logger().Debug("è°ƒè¯•æ—¥å¿—", "data", data)
```

### ä»£ç ç»„ç»‡è§„èŒƒ

#### åŒ…å¯¼å…¥é¡ºåº
```go
import (
    // æ ‡å‡†åº“
    "encoding/json"
    "net/http"
    
    // ç¬¬ä¸‰æ–¹åº“
    "github.com/pocketbase/pocketbase/core"
    
    // é¡¹ç›®å†…éƒ¨åŒ…
    "gitlab.yogorobot.com/sre/lark-base-mapping/types"
)
```

#### å‡½æ•°å‘½åè§„èŒƒ
- å…¬å…±å‡½æ•°ä½¿ç”¨å¤§å†™å­—æ¯å¼€å¤´ï¼ˆå¦‚ `HandleSystemHookEvent`ï¼‰
- ç§æœ‰å‡½æ•°ä½¿ç”¨å°å†™å­—æ¯å¼€å¤´ï¼ˆå¦‚ `handleProjectSystemEvent`ï¼‰
- å¤„ç†å™¨å‡½æ•°ç»Ÿä¸€ä½¿ç”¨ `Handle` å‰ç¼€

#### æ³¨æ„äº‹é¡¹
- ä¿æŒå¯¼å…¥è·¯å¾„çš„ä¸€è‡´æ€§
- æ•°æ®ç»“æ„å®šä¹‰ç»Ÿä¸€åœ¨ `types/` ç›®å½•ä¸­
- ä¸šåŠ¡é€»è¾‘é›†ä¸­åœ¨ `handlers/` ç›®å½•ä¸­
- è·¯ç”±é€»è¾‘ä»…åœ¨ `router/` ç›®å½•ä¸­
- é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•ä¿æŒä¸€è‡´çš„é£æ ¼

## API é›†æˆæ¨¡å¼

### é£ä¹¦ SDK ä½¿ç”¨
```go
// ä»ä¸Šä¸‹æ–‡è·å–é£ä¹¦å®¢æˆ·ç«¯
client, ok := middlewares.GetLarkClientFromContext(e.Request.Context())
if !ok {
    return e.InternalServerError("Failed to get Lark client", nil)
}
```

### GitLab Webhook éªŒè¯
```go
// TokenéªŒè¯
token := e.Request.Header.Get("X-Gitlab-Token")
if token != config.WebhookSecret {
    return e.UnauthorizedError("Invalid GitLab webhook token", nil)
}

// äº‹ä»¶ç±»å‹è·å–
eventType := e.Request.Header.Get("X-Gitlab-Event")
```

### è·¯å¾„å‚æ•°è·å–
```go
baseID := e.Request.PathValue("baseID")
tableID := e.Request.PathValue("tableID")
recordID := e.Request.PathValue("recordID")
```

## æ•°æ®åº“æ“ä½œ

### PocketBase é›†åˆæ“ä½œ
```go
// åˆ›å»ºè®°å½•
record := models.NewRecord(collection)
record.Set("field_name", value)
err := e.App.Save(record)

// æŸ¥è¯¢è®°å½•
records, err := e.App.FindRecordsByFilter(
    collection,
    "field = {:value}",
    map[string]interface{}{"value": searchValue},
)
```

## æœ¬åœ°å¼€å‘

### ç¯å¢ƒè®¾ç½®
```bash
# 1. åˆ›å»º.envæ–‡ä»¶å¹¶é…ç½®ç¯å¢ƒå˜é‡
# 2. å®‰è£…ä¾èµ–
go mod download

# 3. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
go run main.go
```

### æ•°æ®åº“è¿ç§»
- å¼€å‘æ¨¡å¼ä¸‹ï¼Œåœ¨ Dashboard ä¸­ä¿®æ”¹é›†åˆç»“æ„ä¼šè‡ªåŠ¨ç”Ÿæˆè¿ç§»æ–‡ä»¶
- è¿ç§»æ–‡ä»¶ä½äº `migrations/` ç›®å½•ï¼Œä½¿ç”¨æ—¶é—´æˆ³å‘½å

## Docker éƒ¨ç½²

### æœ¬åœ°æ„å»º
```bash
# æ„å»ºé•œåƒ
docker build -t lark-base-mapping .

# è¿è¡Œå®¹å™¨
docker run --env-file .env -p 8080:8080 lark-base-mapping
```

### ç”Ÿäº§éƒ¨ç½²
é¡¹ç›®æ”¯æŒé€šè¿‡ GitHub Actions è‡ªåŠ¨æ„å»ºå¤šæ¶æ„ Docker é•œåƒï¼š
- `ghcr.io/{owner}/lark-base-mapping:latest` - æœ€æ–°ç‰ˆæœ¬
- `ghcr.io/{owner}/lark-base-mapping:v1.0.0` - ç‰ˆæœ¬æ ‡ç­¾

### Kubernetes éƒ¨ç½²ç¤ºä¾‹
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: lark-base-mapping
spec:
  replicas: 2
  selector:
    matchLabels:
      app: lark-base-mapping
  template:
    metadata:
      labels:
        app: lark-base-mapping
    spec:
      containers:
      - name: app
        image: ghcr.io/{owner}/lark-base-mapping:latest
        ports:
        - containerPort: 8080
        env:
        - name: LARK_APP_ID
          valueFrom:
            secretKeyRef:
              name: lark-secrets
              key: app-id
        volumeMounts:
        - name: data
          mountPath: /pb_data
```

## ç›‘æ§å’Œç»´æŠ¤

### å¥åº·æ£€æŸ¥
- `/api/health` - åº”ç”¨å¥åº·çŠ¶æ€
- `/api/realtime` - å®æ—¶è¿æ¥çŠ¶æ€

### æ•°æ®å¤‡ä»½
```bash
# SQLiteæ•°æ®åº“å¤‡ä»½
sqlite3 pb_data/data.db ".backup backup_$(date +%Y%m%d_%H%M%S).db"

# å®Œæ•´æ•°æ®ç›®å½•å¤‡ä»½
tar -czf pb_data_backup_$(date +%Y%m%d_%H%M%S).tar.gz pb_data/
```

### å®‰å…¨é…ç½®
- ç”Ÿäº§ç¯å¢ƒå¯ç”¨ HTTPS
- ä½¿ç”¨ Kubernetes Secrets å­˜å‚¨æ•æ„Ÿä¿¡æ¯
- å®šæœŸè½®æ¢ API å¯†é’¥å’Œ webhook å¯†é’¥
- é…ç½®é˜²ç«å¢™è§„åˆ™é™åˆ¶è®¿é—®
